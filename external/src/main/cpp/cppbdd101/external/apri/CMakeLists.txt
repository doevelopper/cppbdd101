message ("Builidng APR-ICONV in ${TARGET_BUILD_DIRECTORY}")
set(APRI_SOURCE_DIRECTORY ${CMAKE_CURRENT_SOURCE_DIR}/apr-iconv-1.2.2)
set(APR_ICONV_BUILD_DIRECTORY ${CMAKE_CURRENT_BINARY_DIR}/apr-iconv-build)
set(APRI_INCLUDE_DIRECTORY ${APRI_SOURCE_DIRECTORY}/include)
set(APRI_LIBS_DIRECTORY ${APR_ICONV_BUILD_DIRECTORY}/.libs)

file(MAKE_DIRECTORY
  ${APR_ICONV_BUILD_DIRECTORY}
)

set(CONFIGURE_FLAGS "")

set(COMMON_CONFIGURE_FLAGS
  "--with-apr=${CMAKE_CURRENT_BINARY_DIR}/../apr/apr-build"
)

set(CONFIGURE_FLAGS ${COMMON_CONFIGURE_FLAGS})

add_custom_command(OUTPUT ${APR_ICONV_BUILD_DIRECTORY}/Makefile
    COMMAND CC=${CMAKE_C_COMPILER} ${APRI_SOURCE_DIRECTORY}/configure ${CONFIGURE_FLAGS}
    WORKING_DIRECTORY ${APR_ICONV_BUILD_DIRECTORY}
)

add_custom_target(apr-iconv ALL make
  DEPENDS ${APR_ICONV_BUILD_DIRECTORY}/Makefile
  WORKING_DIRECTORY ${APRI_ICONV_BUILD_DIRECTORY}
)

install(
  DIRECTORY ${APRI_LIBS_DIRECTORY}/
  DESTINATION ${TARGET_BUILD_DIRECTORY}/lib
  USE_SOURCE_PERMISSIONS
  #FILES_MATCHING PATTERN libaprutil-1.so*
  FILES_MATCHING PATTERN libapr-iconv.*
)
