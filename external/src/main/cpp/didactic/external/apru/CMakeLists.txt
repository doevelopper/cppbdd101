#message (STATUS "Builidng APR UTILS 1.5.4 in ${TARGET_BUILD_DIRECTORY}")
set(APR_UTIL_SOURCE_DIRECTORY ${CMAKE_CURRENT_SOURCE_DIR}/apr-util-1.5.4)
set(APR_UTIL_BUILD_DIRECTORY ${TARGET_BUILD_DIRECTORY}/apr-util-build)

set(APR_UTIL_LIBS_DIRECTORY ${APR_UTIL_BUILD_DIRECTORY}/.libs)

file(MAKE_DIRECTORY
    ${APR_UTIL_BUILD_DIRECTORY}
)

set(EXPAT_SOURCE_DIRECTORY ${APR_UTIL_SOURCE_DIRECTORY}/../expat-2.1.0)
set(EXPAT_BUILD_DIRECTORY ${APR_UTIL_BUILD_DIRECTORY}/../expat-2.1.0)

set(COMMON_CONFIGURE_FLAGS
    "--with-apr=${TARGET_BUILD_DIRECTORY}/apr-build"
    "--with-expat-source=${EXPAT_SOURCE_DIRECTORY}"
    "--with-expat-build=${EXPAT_BUILD_DIRECTORY}"
)

#message ("COMMON_CONFIGURE_FLAGS ${COMMON_CONFIGURE_FLAGS}") 

set(CONFIGURE_FLAGS ${COMMON_CONFIGURE_FLAGS})

add_custom_command(OUTPUT ${APR_UTIL_BUILD_DIRECTORY}/Makefile
    COMMAND CC=${CMAKE_C_COMPILER} ${APR_UTIL_SOURCE_DIRECTORY}/configure ${CONFIGURE_FLAGS}
    DEPENDS libapr-1
    DEPENDS expat
    WORKING_DIRECTORY ${APR_UTIL_BUILD_DIRECTORY}
)

add_custom_target(apr-util ALL make
    DEPENDS ${APR_UTIL_BUILD_DIRECTORY}/Makefile
    WORKING_DIRECTORY ${APR_UTIL_BUILD_DIRECTORY}
    COMMENT "Build of apr-util library"
)

#add_dependencies(apr-util libapr-1)

install(
    DIRECTORY ${APR_UTIL_LIBS_DIRECTORY}/
    DESTINATION ${TARGET_BUILD_DIRECTORY}/lib
    USE_SOURCE_PERMISSIONS
    #FILES_MATCHING PATTERN libaprutil-1.so*
    FILES_MATCHING PATTERN libaprutil-1.*
)

INSTALL( FILES ${APR_UTIL_BUILD_DIRECTORY}/apu-1-config  
    PERMISSIONS OWNER_EXECUTE OWNER_WRITE OWNER_READ    
    DESTINATION ${TARGET_BUILD_DIRECTORY}/bin
)

mark_as_advanced( FORCE APR_UTIL_LIBS_DIRECTORY APR_UTIL_BUILD_DIRECTORY)
